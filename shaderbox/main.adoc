= Rapid Prototyping of Graphics Shaders in Modern C++
:revealjs_theme: black
:revealjs_transition: fade
:revealjs_controls: true
:revealjs_progress: true
:revealjs_slideNumber: true
:revealjs_history: true
:revealjs_overview: true
:revealjs_fragments: true
:customcss: main.css
:title-slide-background-image: img/title.png
:source-highlighter: highlightjs
:icons: font

== About Me
TODO:

== Agenda
TODO:

== Shaders
[quote]
A computer program that is used to do *shading*
// originally from https://www.clicktorelease.com/talks/scotlandjs-2015/

[%notitle, background-image="img/shaded_shapes.jpg"]
== Shaders Definition
// from https://www.clicktorelease.com/talks/scotlandjs-2015/files/CubeSphereConeCylinderNoBackgrnd.jpg
// alternative: https://qph.ec.quoracdn.net/main-qimg-f441c2d9b120a389f6fa5c995080adaf-c

[quote, Wikipedia]
Depicting depth perception in 3D models or illustrations by varying levels of darkness

[%notitle, background-image="img/pixar_luxo.jpg"]
== Shaders Pixar
// from https://i.ytimg.com/vi/lkKf9DWmR04/maxresdefault.jpg

[quote, Pixar RenderMan 1988]
A computer program that tells the computer how to draw something
//image::https://upload.wikimedia.org/wikipedia/commons/8/84/Phong-shading-sample.jpg[]
// public domain

== Shaders on Modern GPU's
image::http://images.nvidia.com/products/geforce_9600_gt/GeForce_9600_GT_3qtr_med.png[]
//image::https://cryptosrus.com/wp-content/uploads/2017/10/gpu_mining_cards-1280x550.jpg[background]

== Usage on Modern GPU's
[.step]
- computer graphics
- image manipulation
- general purpose - highly parallel - processing

== Why on GPU
image::https://steemitimages.com/0x0/https://steemitimages.com/DQmbboYVYjvhUetEDhh9bQPXz4AxZTBaDujTkSLBtqn7TYv/image.png[]
// https://steemit.com/gridcoin/@dutch/hardware-and-project-selection-part-1-cpu-vs-gpu

== Types of Shaders
image::https://raw.githubusercontent.com/ssloy/tinyrenderer/gh-pages/img/06-shaders/OpenGL-2.0-Programmable-Shader-Pipeline.png[]
// https://github.com/ssloy/tinyrenderer

image::https://glumpy.github.io/_images/gl-pipeline.png[]
// https://glumpy.github.io/modern-gl.html

== Pixel/Fragment Shader
image::https://i.ytimg.com/vi/JtHm6auVnxA/maxresdefault.jpg[]

IMPORTANT: We will concentrate on image-only shaders

== Motivation
I wanted to create real-time effects like...

[%notitle, background-image="img/motivation_snail.jpg"]
== Example 1

[%notitle, background-image="img/motivation_rainforest.png"]
== Example 2

[%notitle, background-image="img/motivation_temple.png"]
== Example 3

== !
on more limited devices...

image:https://upload.wikimedia.org/wikipedia/commons/thumb/0/03/Samsung_Galaxy_S7_and_S7_Edge.png/584px-Samsung_Galaxy_S7_and_S7_Edge.png[s7, 30%, 30%, float="left"]

image:https://thegoodguys.sirv.com/products/50052257/50052257_547863.PNG?scale.height=505&scale.width=773&canvas.height=505&canvas.width=773&canvas.opacity=0&format=png&png.optimize=true[tablet, 40%, 40%, float="right"]

TODO: align and get better pics

[state=commute]
== !
image::img/commute.png[background]
...because of long commutes!

[state=gpu_bug]
== !
image::img/snail-bug.png[background]
also because GPU driver render bugs
WARNING: taken on my desktop PC / Nvidia GTX 1060

== !
and finally: full source code debugging - hard/impossible on GPU's
TODO: image of VS debug

== Shading Languages

[state=RSL]
== Pixar RenderMan Language
image::https://www.clicktorelease.com/talks/scotlandjs-2015/files/renderman.jpg[background]

[.stretch]
[source, javascript]
-----
/* red mesh */                  /* red shaded mesh */
surface basic() {               surface simple(color myOpacity = 1;) {
    Ci = (1.0, 0.0, 0.0);           color myColor = (1.0, 0.0, 0.0);
    Oi = 1;                         normal Nn = normalize(N);
}                                   Ci = myColor * myOpacity * diffuse(Nn);
                                    Oi = myOpacity;
                                }
-----

== Shading Languages History

Real-time rendering:

[.step]
- ARB assembly language
- Cg programming language
- DirectX Shader Assembly Language
- OpenGL shading language (*GLSL*)
- DirectX High-Level Shader Language (*HLSL*)
- PlayStation Shader Language

== A glimpse of GLSL
// from https://www.opengl.org/sdk/docs/tutorials/ClockworkCoders/lighting.php
[source, javascript]
-----
varying vec3 N;
varying vec3 v;

void main(void)
{
   vec3 L = normalize(gl_LightSource[0].position.xyz - v);
   vec4 Idiff = gl_FrontLightProduct[0].diffuse 
        * max(dot(N,L), 0.0);
   Idiff = clamp(Idiff, 0.0, 1.0);

   gl_FragColor = Idiff;
}
-----

== A glimpse of HLSL
// from https://www.gamasutra.com/view/feature/131275/implementing_lighting_models_with_.php?page=2
[source, javascript]
-----
float4 main(
    float3 Light: TEXCOORD0,
    float3 Norm : TEXCOORD1) : COLOR
{
    float4 diffuse = { 1.0f, 0.0f, 0.0f, 1.0f };
    float4 ambient = { 0.1, 0.0, 0.0, 1.0 };
    return ambient + diffuse * saturate(dot(Light, Norm));
}
-----

== GLSL vs HLSL
// from https://docs.microsoft.com/en-us/windows/uwp/gaming/glsl-to-hlsl-reference
|==============================================================================
| Procedural, step-centric (C like) | Object oriented, data-centric (C++ like)
| Compilation done in driver        | Client side compilation
| `float`, `int`, `bool`            | `float`, `int`, `bool`, `uint`, `double`
|==============================================================================

== GLSL vs HLSL (continued)
|==============================================================================
| Vector type: `vec2`, `vec3`, `vec4` | Vector type: `float2`, `float3`, `float4`
| Matrix type: `mat2`, `mat3`, `mat4` | Matrix type: `float2x2`, `float3x3`, `float4x4`
2+^| ...textures, samplers, precision modifiers etc
|==============================================================================

== Shading Languages Future

Basically C++ (usually via LLVM)

[.step]
- Metal Shading Language (C++14, Apple)
 * only on iOS devices
- CUDA Heterogeneous Computing (C++11, NVidia)
 * only for computing, not graphics
- HLSL 6.x (C++98'ish, Microsoft)
 * not released yet

== !
Let's see how C++ can help out, NOW!

[state=plan]
== The Plan

[%step]
- image:img/icon/browser.svg[cpp, 64, 64] Pick a shading language and twist C++ to accept it as source code!
- image:img/icon/management.svg[bonus, 64, 64] BONUS: use the preprocessor for transcription back to the original language(s)!

== The Plan (continued)

[%step]
- obligatory preprocessor layer
- vector (linear algebra) types
 * swizzle support
- matrix types
- operators
- "standard library" utility/math functions

== Place Your Bets

We will chose *GLSL* as it's used on _desktop_, _web_ and _mobile_

WARNING: only a subset of it - concentrate on procedural graphics thus minimize/eliminate inputs (textures, vertex data, etc)

== Language: Declarations

|==============================================================================
| GLSL              | HLSL                  | C++
3+^| classic basic types
3+^| C-style `struct`
| `T name = T ( ... )` | `T name = { ... }` |  both (`_begin()` macro)
|==============================================================================

== Language: Arguments

|===========================================
| GLSL/HLSL     | C++           | Macro glue
| `const in T`  | `const T &`   | `_in(T)`
| `inout T`     | `T &`         | `_inout(T)`
| `out T`       | `T &`         | `_out(T)`
|===========================================

== Language: Vectors and Matrices

[source, cpp]
-----
// vectors are generic
vec2 texcoord1, texcoord2;
vec3 position;
vec4 myRGBA;
ivec2 textureLookup;
bvec3 less;

// matrices are floating point only
mat2 mat2D;
mat3 optMatrix;
mat4 view, projection;
-----

== Vector Swizzle

Syntactic sugar for easy referring to components (or combination of)

|=========================
| { x, y, z, w } | to represent points or normals
| { r, g, b, a } | to refer to colors (`a` is alpha/translucency)
| { s, t, p, q } | texture coordinates
|=========================

== Vector Swizzle - Examples

.subcomponents mix & match
[source, cpp]
-----
vec4 v4;
v4.rgba;  // is a vec4 and the same as just using v4,
v4.rgb;   // is a vec3,
v4.b;     // is a float,
v4.xy;    // is a vec2,
-----

[source, cpp]
-----
vec4 pos = vec4(1.0, 2.0, 3.0, 4.0);
vec4 swiz= pos.wzyx; // swiz = (4.0, 3.0, 2.0, 1.0)
vec4 dup = pos.xxyy; // dup = (1.0, 1.0, 2.0, 2.0)
-----

.l-value assigment
[source, cpp]
-----
pos.xw = vec2(5.0, 6.0); // pos = (5.0, 2.0, 3.0, 6.0)
pos.xx = vec2(3.0, 4.0); // illegal - 'x' used twice
-----

== Vector Swizzle - Motivation

[source, cpp]
-----
vec3 calcNormal( in vec3 pos )
{
    vec2 e = vec2(1.0, -1.0) * 0.0005;

    return normalize(
        e.xyy * map( pos + e.xyy ).x + 
        e.yyx * map( pos + e.yyx ).x + 
        e.yxy * map( pos + e.yxy ).x + 
        e.xxx * map( pos + e.xxx ).x );
}
-----

== Operators

[source, cpp]
-----
vec3 v, u, w;
mat3 m;
                    /* equivalent to */
w = v + u;            w.x = v.x + u.x;
                      w.y = v.y + u.y;
                      w.z = v.z + u.z;

u = v * m;            u.x = dot(v, m[0]); // m[0] is the left column of m
                      u.y = dot(v, m[1]); // dot(a,b) is the inner (dot) product of a and b
                      u.z = dot(v, m[2]);
-----

[state=STL]
== "Standard Library"

//TODO: table styling attrib are ignored
[cols="%20,%80", width="100%"]
|==========================================================
| Math      | `sin`, `cos`, `radians`, `pow`, `exp`, etc
| Common    | `abs`, `sign`, `floor`, `mod`, `min`, etc
| Utility   | `mix`, `step`, `smoothstep`, etc
| Geometry  | `length`, `dot`, `cross`, `distance`, etc 
2+| Specific texture and image sampling ...
|==========================================================

== !

Recreating all this in C++ ...

== Design of `vector<>`

[source, cpp]
-----
template<typename T, size_t N>
struct vector : public vector_base<T, N>
{
	using scalar_type = T;
	using vector_type = vector<T, N>;
	using base_type = vector_base<T, N>;

	vector()
	{
		iterate([&](size_t i) {
			data[i] = 0;
		});
	}
    ...
-----

== `static_for` utility

[source, cpp]
-----
template<size_t Begin, size_t End>
struct static_for
{
	template<class Func>
	void operator ()(Func &&f) {
		f(Begin);

		static_for<Begin + 1, End>()(
			std::forward<Func>(f));
	}
};
-----

[source, cpp]
-----
template<size_t N>
struct static_for<N, N>
{
	template<class Func>
	constexpr void operator ()(Func &&) { /* empty */ }
};
-----

== `vector<>` constructor

[source, cpp]
-----
template<typename... S>
explicit vector(S... args)
{
    static_assert((sizeof...(args) <= N),
        "mismatch number of vector init arguments");

    // dummy forwarding structure
    struct constructor {
        constructor(...) {}
    };

    size_t i = 0;
    constructor(
        { construct_at_index(i, std::forward<S>(args)) ... }
    );
}
-----

NOTE: `{}` init list is used to guarantee left-right order

== constructor specialization

[source, cpp]
-----
bool construct_at_index(size_t &i, scalar_type arg)
{
    data[i++] = arg;
    return true; // dummy return, just because it wil be called in a {} init list
}
-----

[source, cpp]
-----
template<typename Other, size_t Other_N>
bool construct_at_index(size_t &i, vector<Other, Other_N> &&arg)
{
    constexpr auto count = std::min(N, Other_N);
    static_for<0, count>()([&](size_t j) {
        data[i++] = arg.data[j];
    });
    return true;
}
-----

== construction in action

[source, cpp]
-----
using vec2 = vector<int, 2>;
using vec3 = vector<int, 3>;

vec3 v = vec3(99, vec2(98, 100));
//             ^    ^
//             |    |
//             `-- scalar construct gets called
//                  |
//                  `---- sub-vector construct gets called
//                        and then recursively again
-----

== Godbolt

[source, cpp]
-----
int main()
{
    float a, b;
    scanf("%f %f", &a, &b);

    auto v = vec2(a, b);

    printf("%f %f", v.x, v.y);
}
-----

== Godbolt (continued)

[cols="a,a,a"]
|==================
| clang (trunk) | gcc (8.2) | msvc (2017)

| [source, cpp]
-----
call    scanf
movss   xmm0, dword ptr [rsp + 4]
cvtss2sd        xmm0, xmm0
movss   xmm1, dword ptr [rsp]
cvtss2sd        xmm1, xmm1
mov     edi, offset .L.str.1
mov     al, 2
call    printf
-----

| [source, cpp]
-----
call    scanf
pxor    xmm0, xmm0
pxor    xmm1, xmm1
mov     edi, OFFSET FLAT:.LC1
mov     eax, 2
cvtss2sd        xmm0, DWORD PTR [rsp+8]
cvtss2sd        xmm1, DWORD PTR [rsp+12]
call    printf
-----

| [source, cpp]
-----
call    scanf
movss   xmm2, DWORD PTR b$[rsp]
lea     rcx, OFFSET FLAT:`string'
movss   xmm1, DWORD PTR a$[rsp]
cvtps2pd xmm2, xmm2
cvtps2pd xmm1, xmm1
movq    r8, xmm2
movq    rdx, xmm1
call    printf
-----

|==================

WARNING: clang 5.x and 6.x produce worse code

WARNING: gcc's cvtss2sd from memory is pessimization (https://stackoverflow.com/a/16597686)

== `vector_base` foundation

[source, cpp]
-----
template<typename T, size_t N>
struct vector_base
{
	union
	{
		T data[N];
	};
};
-----

NOTE: both anonymous `struct` and `union` are permitted, only MSVC complains with warning

== `vector_base` variation

[source, cpp]
-----
template<typename T>
struct vector_base<T, 2>
{
	union
	{
		T data[2];
		struct { T x, y; };
		struct { T s, t; };
		struct { T u, v; };
    }
};
-----

[source, cpp]
-----
template<typename T>
struct vector_base<T, 3>
{
	union
	{
		T data[3];
		struct { T x, y, z; };
		struct { T r, g, b; };
		struct { T s, t, p; };
    }
};
-----

TODO: clarify union member access https://stackoverflow.com/questions/47168371/what-makes-a-union-member-active / https://en.cppreference.com/w/cpp/language/union

== Swizzle

TIP: We introduce an additional proxy class that allows custom access to the indices and we create all possible permutations (per GLSL standard)

[source, cpp]
-----
union
{
    T data[2];
    struct { T x, y; };
    struct { T s, t; };
    struct { T u, v; };
    swizzler<T, 2, 0, 0> xx, rr, ss;
    swizzler<T, 2, 0, 1> xy, rg, st;
    swizzler<T, 2, 1, 0> yx, gr, ts;
    swizzler<T, 2, 1, 1> yy, gg, tt;
    ...
-----

== Swizzle for `vector<T, 3>`

[source, cpp]
-----
union
{
    T data[3];
    struct { T x, y, z; };
    struct { T r, g, b; };
    struct { T s, t, p; };
    swizzler<T, 3, 0, 0> xx, rr, ss;
    swizzler<T, 3, 0, 1> xy, rg, st;
    swizzler<T, 3, 0, 2> xz, rb, sp;
    swizzler<T, 3, 1, 0> yx, gr, ts;
    swizzler<T, 3, 1, 1> yy, gg, tt;
    swizzler<T, 3, 1, 2> yz, gb, tp;
    swizzler<T, 3, 2, 0> zx, br, ps;
    swizzler<T, 3, 2, 1> zy, bg, pt;
    swizzler<T, 3, 2, 2> zz, bb, pp;
    ...
-----

== ...more swizzle

[source, cpp]
-----
    ...
    swizzler<T, 3, 0, 0, 0> xxx, rrr, sss;
    swizzler<T, 3, 0, 0, 1> xxy, rrg, sst;
    swizzler<T, 3, 0, 0, 2> xxz, rrb, ssp;
    swizzler<T, 3, 0, 1, 0> xyx, rgr, sts;
    swizzler<T, 3, 0, 1, 1> xyy, rgg, stt;
    swizzler<T, 3, 0, 1, 2> xyz, rgb, stp;
    swizzler<T, 3, 0, 2, 0> xzx, rbr, sps;
    swizzler<T, 3, 0, 2, 1> xzy, rbg, spt;
    swizzler<T, 3, 0, 2, 2> xzz, rbb, spp;
    swizzler<T, 3, 1, 0, 0> yxx, grr, tss;
    swizzler<T, 3, 1, 0, 1> yxy, grg, tst;
    swizzler<T, 3, 1, 0, 2> yxz, grb, tsp;
    swizzler<T, 3, 1, 1, 0> yyx, ggr, tts;
    swizzler<T, 3, 1, 1, 1> yyy, ggg, ttt;
    swizzler<T, 3, 1, 1, 2> yyz, ggb, ttp;
    swizzler<T, 3, 1, 2, 0> yzx, gbr, tps;
    swizzler<T, 3, 1, 2, 1> yzy, gbg, tpt;
    swizzler<T, 3, 1, 2, 2> yzz, gbb, tpp;
    ...
-----

== ...even more swizzle!

[source, cpp]
-----
    ...
    swizzler<T, 3, 2, 1, 0, 0> zyxx, bgrr, ptss;
    swizzler<T, 3, 2, 1, 0, 1> zyxy, bgrg, ptst;
    swizzler<T, 3, 2, 1, 0, 2> zyxz, bgrb, ptsp;
    swizzler<T, 3, 2, 1, 1, 0> zyyx, bggr, ptts;
    swizzler<T, 3, 2, 1, 1, 1> zyyy, bggg, pttt;
    swizzler<T, 3, 2, 1, 1, 2> zyyz, bggb, pttp;
    swizzler<T, 3, 2, 1, 2, 0> zyzx, bgbr, ptps;
    swizzler<T, 3, 2, 1, 2, 1> zyzy, bgbg, ptpt;
    swizzler<T, 3, 2, 1, 2, 2> zyzz, bgbb, ptpp;
    swizzler<T, 3, 2, 2, 0, 0> zzxx, bbrr, ppss;
    swizzler<T, 3, 2, 2, 0, 1> zzxy, bbrg, ppst;
    swizzler<T, 3, 2, 2, 0, 2> zzxz, bbrb, ppsp;
    swizzler<T, 3, 2, 2, 1, 0> zzyx, bbgr, ppts;
    swizzler<T, 3, 2, 2, 1, 1> zzyy, bbgg, pptt;
    swizzler<T, 3, 2, 2, 1, 2> zzyz, bbgb, pptp;
    swizzler<T, 3, 2, 2, 2, 0> zzzx, bbbr, ppps;
    swizzler<T, 3, 2, 2, 2, 1> zzzy, bbbg, pppt;
    swizzler<T, 3, 2, 2, 2, 2> zzzz, bbbb, pppp;
-----

== `swizzler<>` design

TODO: ...

== Operators and Functions

TODO: ...

== Limitations and Problems

TODO: ...

== Solutions

TODO: ...

== the `matrix<>` datatype

TODO: ...

== Prior Art

TODO: ...

== SHOWCASE

== !

//TODO: doesn't work
//[.step]
...but first: Crash Course into Procedural Graphics!

NOTE: Courtesy of @ReinderNijhoff https://www.shadertoy.com/view/4dSfRc

[%notitle, background-image="img/tutorial/step_1.png"]
== raymarch tutorial step 1
[%notitle, background-image="img/tutorial/step_2.png"]
== raymarch tutorial step 2
[%notitle, background-image="img/tutorial/step_3.png"]
== raymarch tutorial step 3
[%notitle, background-image="img/tutorial/step_4.png"]
== raymarch tutorial step 4
[%notitle, background-image="img/tutorial/step_5.png"]
== raymarch tutorial step 5
[%notitle, background-video="vid/raymarch.mp4", options="loop,muted"]
== raymarch tutorial step 6
[%notitle, background-image="img/tutorial/step_7.png"]
== raymarch tutorial step 7
[%notitle, background-image="img/tutorial/step_8.png"]
== raymarch tutorial step 8

== Results

[%step]
- GPU on desktop PC
 * https://www.shadertoy.com/user/valentingalea
 * Nvidia GeForce 1060
 * 1080p
- CPU on desktop PC
 * AMD FX 8350 8-core 4.00 GHz
 * Microsoft Visual C++ 15.7.6
 * 320x240px

== Results (continued)

- CPU mobile phone
 * Samsung Galaxy S7
 * C4Droid app (https://play.google.com/store/apps/details?id=com.n0n3m4.droidc)
 * GCC 7.2.0
 * 100x100px

[%notitle, background-video="vid/planet.mp4", options="loop,muted"]
== Planet (GPU)

== Planet (CPU)

|==========================================================================================
| image:img/pc_planet.png[Planet(PC)] | image:img/droid_planet.jpg[Planet(Droid), 300, 300]
| Desktop PC                          | Mobile Phone
| .1 FPS :(                           | 5 FPS
|==========================================================================================

== Clouds (GPU)

TODO: capture video

== Clouds (CPU)

TODO: integrate old shader
TODO: capture pics/vid

== Vinyl Turntable (GPU)

TODO: capture video

== Vinyl Turntable (CPU)

TODO: capture pics/vid

== Egg (GPU)

TODO: capture video (disable 3d and longer)
TODO: only on GPU

== The End

TODO: links

== Credits / Acknowledgements

Motivation Shaders: https://www.shadertoy.com/view/ld3Gz2 https://www.shadertoy.com/view/ldScDh https://www.shadertoy.com/view/4ttSWf

TODO: the rest
